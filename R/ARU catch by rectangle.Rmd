---
output: 
  word_document:
    reference_docx: ../report_template_v1.5.dotx
---

```{r setup, echo=FALSE, fig.asp=1.0, fig.align="center", message=FALSE, warning=FALSE}

# =======================================================================================
# ARU catch by rectangle.Rmd
# 
# Generate catch by rectangle plot
#
# 14/11/2019 First coding; integrated with sharepoint data
# =======================================================================================

require("knitr")
knitr::opts_chunk$set(echo = FALSE,	message = FALSE,	warning = FALSE,	comment = "",	crop = TRUE )
knitr::opts_chunk$set(fig.width=10) 

rm(list=ls())

library(tidyverse)    # tidying packages
library(readxl)       # read excel
library(lubridate)
library(data.table)
library(scales)
library(RColorBrewer)
library(viridis)
library(pander)

# lowcase function
lowcase <- function(df) {
  names(df) <- tolower(names(df)) %>% gsub("\\?|\\s+|\\.+|_+|\\(|\\)","",.) 
  df
}

# Data path
datapath <- "//community.ices.dk/ExpertGroups/benchmarks/2020/wkdeep/2014 Meeting docs/06. Data"
# datapath  <- "//community.ices.dk@SSL/DavWWWRoot/ExpertGroups/benchmarks/2020/wkdeep/2014 Meeting docs/06. Data"
# datapath <- "D:/WGWIDE/2019/06. Data/_catch_by_rectangle"
# datapath <- "D:/temp"

# load spatial datasets
load(file.path(datapath, "rdata/world.df.RData"))
load(file.path(datapath, "rdata/fao.df.RData"))
icesrectangles.df <-
  get(load(file.path(datapath, "rdata/icesrectangles.df.RData"))) %>% 
  mutate(rect = as.character(rect)) %>% 
  group_by(rect) %>% 
  filter(row_number() == 1) %>% 
  distinct(rect, lat, lon=long)

# list the available files
fn <- file.path(datapath, "combined","CatchByRectangle all.xlsx")

# read the files and start with an empty data frame
catch_by_species_year_country_raw <- 
    read_excel(fn, col_names=TRUE, col_types="text") %>% 
    lowcase() %>% 
    mutate_at(c("year","pnum"), list(as.integer) )  %>% 
    # mutate_at(c("lat","lon","catch"), list(as.numeric) )  %>%
    mutate_at(c("catch"), list(as.numeric) )  %>%
    mutate(rect = gsub("\\s+","", rect)) %>% 
    dplyr::select(-one_of("lat","lon")) %>% 
    
    # add lat lon for rectangle
    left_join(dplyr::select(icesrectangles.df, rect, lat, lon), 
              by="rect") 

# catch by year
catch_by_species_year <- 
  catch_by_species_year_country_raw %>%
  
  # mutate(species = "ARU") %>% 
  
  group_by(species, year, rect, lat, lon) %>% 
  summarize(catch = sum(catch, na.rm=TRUE)) %>% 
  
  mutate(catch_interval = cut(as.integer(catch), breaks=c(1 %o% 10^(0:12)), dig.lab=10 ) ) %>% 
  mutate(catch_interval = gsub(" ","", catch_interval)) %>% 
  filter(!is.na(catch_interval)) %>% 
  filter(grepl("\\,", catch_interval)) %>%   
  group_by(species, year, rect, lat, lon, catch_interval) %>% 
  summarize(catch = sum(catch, na.rm=TRUE))


# ================================================================================
# FUNCTIONS
# ================================================================================

table_catch_by_year_country <- function(myspecies="MAC", myyears=NA) {
  
  # t <-
    catch_by_species_year_country_raw %>% 
    filter(species == myspecies) %>% 
    {if ((length(myyears) == 1) & all(is.na(myyears))) {
      filter(.)
    } else {
      filter(., year %in% myyears)
    }} %>% 

    group_by(species, year, country) %>% 
    summarize(catch = as.integer(sum(catch, na.rm=TRUE))) %>% 
    dcast(country ~ year, value.var="catch", sum, margins=c("year","country")) %>% 
    # { if (ncol(.) > split) }
    pandoc.table(.,
               style = "simple",
               split.tables=120, 
               justify = "right",
               missing=".")

} # end of table_catch_by_year_country




# table_catch_by_year_country (myspecies="MAC")

table_catch_by_year_species <- function(myyears=NA) {
  
  catch_by_species_year_country_raw %>% 
    {if ((length(myyears) == 1) & all(is.na(myyears))) {
      filter(.)
    } else {
      filter(., year %in% myyears)
    }} %>% 

    group_by(species, year) %>% 
    summarize(catch = as.integer(sum(catch, na.rm=TRUE))) %>% 
    dcast(species ~ year, value.var="catch", sum, margins=c("year","country")) %>% 
    # { if (ncol(.) > split) }
    pandoc.table(.,
               style = "simple",
               split.tables=120, 
               justify = "right",
               missing=".")

} # end of table_catch_by_year_species




plot_catch_by_year <- function(myspecies="MAC", myyears=NA, plot_catch=TRUE, plot_ssb=FALSE, ncol=6) {
  
  catch2 <-
    catch_by_species_year %>% 
    filter(species == myspecies) %>%
    {if ((length(myyears) == 1) & all(is.na(myyears))) {
      filter(.)
    } else {
      filter(., year %in% myyears)
    }} %>% 
    
    {if (!all(is.na(myyears))) bind_rows(., data.frame(year = myyears)) else (.) }

  xlim <- range(catch2$lon, na.rm=TRUE)
  ylim <- range(catch2$lat, na.rm=TRUE)

  tc <-
    catch2 %>% 
    group_by(species, year) %>% 
    summarize(catch = sum(catch, na.rm=TRUE)) %>% 
    mutate(catch  = as.integer(catch/1000) ) %>% 
    
    group_by(species) %>% 
    mutate(catch2 = ylim[1] + (catch / max(catch, na.rm=TRUE) * (ylim[2] - ylim[1])) )
  
  catch2 %>% 
    filter(!is.na(catch_interval)) %>% 
    ggplot(aes(lon, lat)) + 
    theme_bw() +
    theme(panel.border     = element_rect(colour="black" , size=0.2),
          panel.grid.major = element_blank(),
          strip.background = element_rect(colour="black", size =0.2),
          plot.margin      = unit(c(0,0,0,0),"cm"),
          plot.title       = element_text(hjust=0, vjust=0, size=10),
          axis.text        = element_text(size=6),
          legend.key.width = unit(0.4, "cm"), 
          legend.position  = "bottom",
          axis.title       = element_blank()) +
    
    coord_quickmap(xlim=xlim, ylim=ylim) +
  
    geom_polygon(data=fao.df, aes(long, lat, group=group), fill = NA, size=0.2,
                 color="gray80", alpha=0.3) +
  
    geom_tile(aes(fill = catch_interval, height=0.5, width=1), colour=NA, alpha=1.0) +
    scale_fill_viridis(option = "plasma", direction = -1, discrete=TRUE) +
  
    geom_polygon(data=world.df, aes(long, lat, group=group), fill = "cornsilk", 
                 size=0.1, color="black") +
    
    labs(x = NULL, y = NULL, size = "tons", title=unique(catch2$species)) +
    guides(fill = guide_legend(nrow = 1, title="catch (tonnes)")) +
    facet_wrap( ~ year, ncol=ncol)

} # end of plot_catch_by_year



```
Working document xx, WKGSS 2020

**Utilizing the full time-series of catch by rectangle**

Martin Pastoors, `r format(Sys.time(), '%d/%m/%Y')`

**Abstract**

**Introduction**

**Results**

```{r, echo=FALSE, fig.asp=1.4, fig.align="center", message=FALSE, warning=FALSE}

table_catch_by_year_country(myspecies="ARU")

```


```{r, echo=FALSE, fig.asp=1.4, fig.align="center", message=FALSE, warning=FALSE}

plot_catch_by_year(myspecies=c("ARU"), myyears = 2010:2019, ncol=4)

```

